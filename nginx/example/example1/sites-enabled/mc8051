server {
	listen 80 default_server;
	listen [::]:80 default_server;

	server_name _;

	root /var/www/html;
}


server {
	listen 80 default_server;
	listen [::]:80 default_server;

	server_name www.mc8051.de admin.mc8051.de cloud.mc8051.de git.mc8051.de;

	return 301 https://$host$request_uri;
}

server {
	listen 80 default_server;
	listen [::]:80 default_server;

	server_name mc8051.de;

	return 301 https://www.mc8051.de$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    ssl_certificate /etc/letsencrypt/live/mc8051.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mc8051.de/privkey.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    root /var/www/html/website;
    index index.php index.html index.htm;

    server_name www.mc8051.de;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_pass unix:/var/run/php5-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}

server {
	# https://docs.nextcloud.com/server/11/admin_manual/installation/nginx_nextcloud_9x.html
	listen 443 ssl default_server http2;
	listen [::]:443 ssl http2;

    ssl_certificate /etc/letsencrypt/live/mc8051.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mc8051.de/privkey.pem;

	root /var/www/html/cloud;
	index index.php index.html index.htm;

	server_name cloud.mc8051.de;

    # Disable gzip to avoid the removal of the ETag header
	gzip off;

  	# Uncomment if your server is build with the ngx_pagespeed module
  	# This module is currently not supported.
  	#pagespeed off;

	rewrite ^/caldav(.*)$ /remote.php/caldav$1 redirect;
	rewrite ^/carddav(.*)$ /remote.php/carddav$1 redirect;
	rewrite ^/webdav(.*)$ /remote.php/webdav$1 redirect;

	index index.php;
	error_page 403 /core/templates/403.php;
	error_page 404 /core/templates/404.php;

	location = /robots.txt {
		allow all;
		log_not_found off;
		access_log off;
	}

	location ~ ^/(?:\.htaccess|data|config|db_structure\.xml|README){
		deny all;
	}

	location / {
		# The following 2 rules are only needed with webfinger
		rewrite ^/.well-known/host-meta /public.php?service=host-meta last;
		rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json last;

		rewrite ^/.well-known/carddav /remote.php/carddav/ redirect;
		rewrite ^/.well-known/caldav /remote.php/caldav/ redirect;

		rewrite ^(/core/doc/[^\/]+/)$ $1/index.html;

		try_files $uri $uri/ =404;
	}

    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_pass unix:/var/run/php5-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

	# Adding the cache control header for js and css files
	# Make sure it is BELOW the location ~ \.php(?:$|/) { block
	location ~* \.(?:css|js)$ {
		add_header Cache-Control "public, max-age=7200";
		# Add headers to serve security related headers
		add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload;";
		add_header X-Content-Type-Options nosniff;
		add_header X-Frame-Options "SAMEORIGIN";
		add_header X-XSS-Protection "1; mode=block";
		add_header X-Robots-Tag none;
		# Optional: Don't log access to assets
		access_log off;
	}

	# Optional: Don't log access to other assets
	location ~* \.(?:jpg|jpeg|gif|bmp|ico|png|swf)$ {
		access_log off;
	}
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    ssl_certificate /etc/letsencrypt/live/mc8051.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mc8051.de/privkey.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    root /var/www/html/admin;
    index index.php index.html index.htm;

    server_name admin.mc8051.de;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_pass unix:/var/run/php5-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}

server {
    listen       443 ssl;
    listen [::]:443 ssl http2;

    ssl_certificate /etc/letsencrypt/live/mc8051.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mc8051.de/privkey.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    root   /var/www/html/;
    index  index.html index.php index.htm;

    server_name  git.mc8051.de;

    ## Definition Reverse Proxy ##
    location / {
        proxy_pass  http://127.0.0.1:3000/;
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_redirect off;
        proxy_buffering off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
   }
}